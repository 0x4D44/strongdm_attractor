# Branch Coverage Plan: 92.41% → 100%

**Date:** 2026-02-11
**Target:** 100% branch coverage (MC/DC-level completeness)
**Remaining:** 176 uncovered branches across ~30 files

---

## Team Allocation

### Agent A: Unified LLM Layer (adapters + utils)
~85 uncovered branches

### Agent B: Agent Loop + Attractor Engine
~91 uncovered branches

---

## Agent A: Unified LLM Branches

### openai.ts — 76.92% branches (~24 uncovered)

**Streaming switch cases (lines 287-395):**
1. `response.output_text.delta` — text delta event
2. `response.output_text.done` — text end event
3. `response.function_call_arguments.delta` — tool call arg accumulation
4. `response.output_item.added` with type="function_call" — tool call start
5. `response.output_item.done` with type="function_call" — tool call end
6. `response.completed` — final event with usage parsing
7. `response.created` / `response.in_progress` — ID/model capture
8. Unknown event type — should be silently ignored (default/no-op)

**buildRequestBody branches (lines 95-213):**
9. Image with `url` vs `data` (line 135 vs 141)
10. Image with `detail` attribute (lines 139, 146)
11. TOOL_CALL in user message (line 152) — graceful fallback
12. `reasoning_effort` set (line 186)
13. `response_format.type === "json_schema"` (line 192)
14. `response_format.type === "json"` (line 200)
15. `provider_options?.openai` passthrough (line 207)
16. `tool_choice` with mode "named" (line 521)

**parseResponse branches (lines 428-500):**
17. Output item type="message" vs "function_call" (lines 439, 446)
18. Usage with output_tokens_details/input_details (lines 466-467)
19. `usageData` present vs absent (line 465)

**mapFinishReason branches (lines 525-542):**
20. `length` / `incomplete` → length
21. `tool_calls` → tool_calls (without hasToolCalls)
22. `content_filter` → content_filter
23. default → other

### anthropic.ts — 85.61% branches (line 637)

24. `translateToolChoice` with mode "none" → `{ type: "auto" }`

### gemini.ts — 85.34% branches (lines 299-300, 498)

25. `fullText` present but `textStarted` false → push content without TEXT_END (line 298-299)
26. `translateToolChoice` with mode="named" → allowedFunctionNames (line 503-504)
27. Various streaming branches (functionCall in parts, thinking parts, finishReason mapping)

### api.ts — 88.66% branches (lines 148, 162-166)

28. `abort_signal` already aborted at top of loop → throw timeout or abort error (line 145-150)
29. Abort signal races in Promise.race — signal fires during completeCall (lines 161-166)

### client.ts — 97.05% branches (lines 197-198)

30. `getDefaultClient()` path — creates client from env when no default set

### middleware.ts — 93.33% (line 70)

31. `wrapMiddlewareForStream` catch block — middleware throws on dummy response

### types.ts — 98.94% (line 238)

32. `Usage.add()` — both optional fields are null/undefined → returns undefined

### http.ts — 94.52% (lines 75, 128-129, 178)

33. AbortError with `signal?.aborted` true → throw AbortError (not TimeoutError)
34. Stream AbortError with `signal?.aborted` true → throw AbortError
35. `parseRateLimitHeaders` — all headers absent → return undefined (line 175)
36. Rate limit header with partial values (line 178 — some present, some not)

### sse.ts — 96.07% (lines 121-122)

37. Buffer flush at end of stream — remaining buffer with data that forms events

---

## Agent B: Agent Loop + Attractor Engine Branches

### loop.ts — 89.13% branches (lines 189-196, 201, 256-258)

1. `discoverProjectDocs` — content exceeds 32KB → truncation (lines 189-196)
2. `discoverProjectDocs` — file read throws (line 199-201 catch block)
3. `detectLoop` — `chunk.length !== pattern.length` (lines 255-258)

### session.ts — 96% (line 106)

4. `submit()` error catch — error is non-Error object → String(err)

### subagent.ts — 97.05% (lines 168-171)

5. `wait()` — agent has no promise and no result → returns default {output:'', success:false}

### local.ts — 83.13% (lines 249-356, 438-439)

6. `grep()` with ripgrep available → builds rg args with -i, -m, -g flags
7. `grep()` with ripgrep NOT available → falls back to grep -rn
8. `grep()` with `glob_filter` option (both rg and grep paths)
9. `grep()` result with exit_code=1 and empty stdout → "No matches found"
10. `glob()` with fs.glob available → collects results, sorts by mtime
11. `glob()` with fs.glob NOT available → falls back to find command
12. `glob()` stat error on a file → mtime=0 fallback
13. `_commandExists()` catch → returns false
14. `_filterEnv()` with policy='inherit_all' vs 'inherit_core' vs 'inherit_none'
15. `_filterEnv()` sensitive pattern filtering

### openai-profile.ts — 90.27% (lines 118-119, 165-167)

16. `parseDiffOutput` — unknown line prefix (line 118: else branch, `i++`)
17. `applyHunksToContent` — fuzzy match fallback (lines 165-167, 172-174)

### gemini-profile.ts — 96% (line 60)

18. `read_file` error catch → error message formatting

### registry.ts — 86.84% (lines 53-54)

19. `validateToolArgs` — schema is null/not-object → return valid (line 52-53)
20. `validateToolArgs` — required field missing → error (already tested?)

### conditions.ts — 97.72% (line 66)

21. `evaluateClause` — empty/whitespace-only clause → returns true

### stylesheet.ts — 96.87% (lines 67, 196, 273)

22. Universal selector `*` → SelectorType.UNIVERSAL (line 70-72)
23. `pos >= source.length` after reading selector → break (line 196)
24. Property map fallback `||` — unknown property name passes through

### utils.ts — 90.9% (line 31)

25. `parseDuration` — unknown time unit defaults to raw value

### pipeline.ts — 87.80% (lines 162, 282, 416, 434-437)

26. Checkpoint resume at terminal — no next edge → return early (line 161-169)
27. SKIPPED node → nextEdge not found → break (line 277)
28. `executeWithRetry` — SKIPPED status → return immediately (line 412-413)
29. `executeWithRetry` — fall-through after max attempts (lines 434-437)
30. `executeWithRetry` — `allow_partial` on retry exhaustion (line 395-399)

### edge-selection.ts — 96.77% (line 36)

31. `bestByWeightThenLexical` — empty edges array → return undefined

### context.ts — 96.77% (lines 32-33)

32. `get()` nested key — intermediate is null → returns undefined
33. `get()` nested key — intermediate is non-object (number/string) → returns undefined

### dot-parser.ts — 94.31% (lines 149, 370, 539, 553)

34. Unexpected token in parseStatement → throws error (line 149)
35. Expected value got unexpected token → throws error (line 370)
36. `expectIdentifier` — keyword as identifier (SUBGRAPH) (line 535)
37. `expectIdentifierOrString` — keyword-like token (line 549-551)
38. `expectIdentifierOrString` — truly unexpected → throws error (line 553)

### validator.ts — 93.49% (lines 322, 430-433, 441)

39. `retryTargetExistsRule` — graph-level retry_target doesn't exist (line 324-329)
40. `retryTargetExistsRule` — graph-level fallback_retry_target doesn't exist (line 331-336)
41. `validateConditionSyntax` — `!=` with more than 2 parts → error
42. `validateConditionSyntax` — `!=` with empty key → error
43. `validateConditionSyntax` — bare key (no = or !=) → allowed

### fan-in.ts — 89.47% (lines 58-59)

44. `outcomeRank` — unknown outcome falls back to rank 3 (line 58 `?? 3`)

### parallel.ts — 96.87% (line 98)

45. `resultsSummary` — branch that has no matching to node → `branch_${i}` fallback

### tool-handler.ts — 85.71% (line 27)

46. Tool handler timeout parsing — `node.attrs.timeout` is undefined → default 30000

---

## Validation

After agents finish:
```bash
rm -rf coverage/.tmp coverage && npx vitest run --coverage
```

Target: **100% branch coverage** across all files.
