# Code Coverage Analysis Report

**Date:** 2026-02-11
**Project:** Attractor Pipeline Engine
**Tool:** vitest + v8 coverage

## Executive Summary

| Metric     | Current | Target | Gap      |
|-----------|---------|--------|----------|
| Statements | 89.71%  | 98%    | -8.29pp  |
| Branches   | 84.26%  | 98%    | -13.74pp |
| Functions  | 97.74%  | 98%    | -0.26pp  |
| Lines      | 89.71%  | 98%    | -8.29pp  |

**887 tests across 43 test files. All passing.**

---

## Layer-by-Layer Coverage

### Unified LLM Layer (src/unified-llm/)

| File | Stmts | Branch | Funcs | Lines | Notes |
|------|-------|--------|-------|-------|-------|
| api.ts | 88.99% | 78.26% | 90.9% | 88.99% | generate_object, stream edge cases |
| client.ts | 94.16% | 96.77% | 83.33% | 94.16% | getDefaultClient, setDefaultClient |
| middleware.ts | 100% | 93.33% | 100% | 100% | Near-perfect |
| model-catalog.ts | 100% | 100% | 100% | 100% | Perfect |
| types.ts | 100% | 98.94% | 100% | 100% | Near-perfect |
| adapters/anthropic.ts | 88.9% | 67.85% | 100% | 88.9% | Streaming gaps, content types |
| adapters/gemini.ts | 88.72% | 63.54% | 100% | 88.72% | Streaming gaps, tool calls |
| adapters/openai.ts | 92.84% | 54.38% | 100% | 92.84% | Streaming branch coverage low |
| utils/http.ts | 100% | 94.52% | 100% | 100% | Near-perfect |
| utils/retry.ts | 100% | 100% | 100% | 100% | Perfect |
| utils/sse.ts | 94.59% | 93.02% | 100% | 94.59% | Stream error paths |

**Layer average: ~95.25% statements, 89.74% branches**

### Agent Loop Layer (src/agent-loop/)

| File | Stmts | Branch | Funcs | Lines | Notes |
|------|-------|--------|-------|-------|-------|
| events.ts | 95.23% | 97.36% | 100% | 95.23% | Minor gap |
| loop.ts | 81.43% | 76.71% | 100% | 81.43% | Core loop, tool execution |
| session.ts | 81.05% | 80% | 90% | 81.05% | State machine, close() |
| subagent.ts | 55.16% | 91.3% | 85.71% | 55.16% | **Worst in project** |
| truncation.ts | 100% | 100% | 100% | 100% | Perfect |
| types.ts | 100% | 100% | 100% | 100% | Perfect |
| execution/local.ts | 89.66% | 80.24% | 100% | 89.66% | grep, glob, env vars |
| execution/types.ts | 0% | 0% | 0% | 0% | Interface-only file |
| tools/anthropic-profile.ts | 100% | 100% | 100% | 100% | Perfect |
| tools/gemini-profile.ts | 93.81% | 95.45% | 88.88% | 93.81% | Minor gap |
| tools/openai-profile.ts | 98.05% | 90.27% | 100% | 98.05% | Near-perfect |
| tools/registry.ts | 97.93% | 86.11% | 100% | 97.93% | Near-perfect |
| tools/shared.ts | 100% | 100% | 100% | 100% | Perfect |

**Layer average: ~77.83% statements, 85.96% branches** (dragged down by subagent.ts)

### Attractor Engine Layer (src/attractor/)

| File | Stmts | Branch | Funcs | Lines | Notes |
|------|-------|--------|-------|-------|-------|
| conditions.ts | 100% | 97.72% | 100% | 100% | Near-perfect |
| events.ts | 100% | 100% | 100% | 100% | Perfect |
| interviewer.ts | 55.55% | 100% | 90.9% | 55.55% | ConsoleInterviewer untested |
| stylesheet.ts | 96.41% | 93.47% | 100% | 96.41% | Escape handling edge cases |
| transforms.ts | 100% | 100% | 100% | 100% | Perfect |
| types.ts | 100% | 100% | 100% | 100% | Perfect |
| utils.ts | 100% | 90.9% | 100% | 100% | Near-perfect |
| engine/checkpoint.ts | 100% | 100% | 100% | 100% | Perfect |
| engine/context.ts | 92.53% | 92.85% | 100% | 92.53% | Nested key edge cases |
| engine/edge-selection.ts | 95% | 90% | 100% | 95% | Weight tiebreaker |
| engine/pipeline.ts | 81.81% | 77.77% | 94.11% | 81.81% | Checkpoint resume, retry, goal gates |
| handlers/codergen.ts | 100% | 89.47% | 100% | 100% | Near-perfect |
| handlers/conditional.ts | 100% | 100% | 100% | 100% | Perfect |
| handlers/exit.ts | 100% | 100% | 100% | 100% | Perfect |
| handlers/fan-in.ts | 84.12% | 72.22% | 100% | 84.12% | JSON parse error, empty results |
| handlers/parallel.ts | 71.42% | 69.56% | 100% | 71.42% | first_success, fail_fast, simulation |
| handlers/stack-manager.ts | 100% | 100% | 100% | 100% | Perfect |
| handlers/start.ts | 100% | 100% | 100% | 100% | Perfect |
| handlers/tool-handler.ts | 100% | 85.71% | 100% | 100% | Near-perfect |
| handlers/wait-human.ts | 76.76% | 86.2% | 100% | 76.76% | Timeout, skip, empty label |
| parser/dot-lexer.ts | 100% | 100% | 100% | 100% | Perfect |
| parser/dot-parser.ts | 90.2% | 79.51% | 100% | 90.2% | Subgraph edge cases |
| parser/validator.ts | 80.34% | 76.52% | 100% | 80.34% | Condition syntax validation |

**Layer average: ~88.95% statements, 96.36% branches**

---

## Top 10 Files Needing Coverage (by uncovered lines)

| Rank | File | Lines Cov | Gap | Uncovered Lines (~) | Estimated Tests |
|------|------|-----------|-----|---------------------|-----------------|
| 1 | agent-loop/subagent.ts | 55.16% | ~171 | spawn promise chain, createSubagentTools | 12-15 |
| 2 | attractor/interviewer.ts | 55.55% | ~112 | ConsoleInterviewer, findMatchingOption | 8-10 |
| 3 | agent-loop/loop.ts | 81.43% | ~111 | processInput loop body, tool execution | 10-15 |
| 4 | attractor/engine/pipeline.ts | 81.81% | ~102 | checkpoint resume, retry, goal gates | 12-15 |
| 5 | attractor/parser/validator.ts | 80.34% | ~97 | validateConditionSyntax, extraRules | 6-8 |
| 6 | attractor/handlers/parallel.ts | 71.42% | ~41 | first_success, fail_fast, simulation | 6-8 |
| 7 | agent-loop/execution/local.ts | 89.66% | ~46 | grep, glob, env policy | 5-7 |
| 8 | unified-llm/adapters/anthropic.ts | 88.9% | ~73 | Streaming blocks, content types | 6-8 |
| 9 | unified-llm/adapters/gemini.ts | 88.72% | ~54 | Streaming tool calls | 5-7 |
| 10 | attractor/handlers/wait-human.ts | 76.76% | ~37 | Timeout, skip, empty label | 4-5 |

---

## Detailed Gap Analysis

### 1. subagent.ts (55.16%) — CRITICAL

**Uncovered:**
- Lines 87-133: `spawn()` promise chain (success path at 89-113, error path at 115-133)
- Lines 263-382: Entire `createSubagentTools()` function + tool executor closures

**Why uncovered:** Tests mock at the SubAgentManager level but never exercise the promise resolution paths or the tool executor wrappers.

**Fix:** Mock `Session.submit()` to resolve/reject and verify event emission + state transitions. Test each tool executor independently.

### 2. interviewer.ts (55.55%) — HIGH

**Uncovered:**
- Lines 59-127: `ConsoleInterviewer` class (readline-based)
- Lines 241-249: `findMatchingOption()` helper

**Why uncovered:** Console interaction is hard to test. But we can mock readline.

**Fix:** Mock `readline.createInterface` and test all question types. Test `findMatchingOption` directly.

### 3. loop.ts (81.43%) — HIGH

**Uncovered:**
- Lines 466-483: Turn limits in processInput while loop
- Lines 485-487: abort_signaled check
- Lines 570-584: Loop detection injection
- Lines 592-596: Followup queue processing

**Fix:** Test processInput with a mock LLMClient that returns tool calls, then completes. Test abort signaling. Test loop detection triggering. Test follow-up queue draining.

### 4. pipeline.ts (81.81%) — HIGH

**Uncovered:**
- Lines 140-178: `resumeFromCheckpoint` code path
- Lines 237-246: Goal gate failure + retry target lookup
- Lines 262-266: `auto_status` path
- Lines 272-285: SKIPPED status handling
- Lines 316-318: FAIL with no outgoing edge
- Lines 325-341: `loop_restart` edge handling
- Lines 521-533: `defaultShouldRetry` conditions
- Lines 543-544: `mirrorGraphAttributes` default_fidelity branch

**Fix:** Test checkpoint resume flow. Test goal gate with failing node and retry target. Test auto_status. Test SKIPPED node. Test loop_restart edge.

### 5. validator.ts (80.34%) — MEDIUM

**Uncovered:**
- Lines 437-463: `validateConditionSyntax()` — malformed conditions with multiple = or != operators, missing keys
- Lines 472-473: `validate()` with extraRules

**Fix:** Test malformed conditions (e.g., `a=b=c`, `=value`, `!=`, `a!=b!=c`). Test validate() with custom rules array.

### 6. parallel.ts (71.42%) — MEDIUM

**Uncovered:**
- Lines 40-49: Policy attribute parsing
- Lines 80-87: No-executor simulation path
- Lines 119-133: `first_success` join policy
- Lines 135-140: Default join policy fallthrough

**Fix:** Test with executor=null (simulation). Test first_success with mixed results. Test fail_fast early termination.

### 7. local.ts (89.66%) — MEDIUM

**Uncovered:**
- Lines ~249-356: grep() and glob() implementations
- Lines 438-439: env var filtering edge case

**Fix:** Test grep with regex patterns. Test glob with wildcards. Test env var filtering policies.

### 8-9. Adapter streaming (anthropic 88.9%, gemini 88.72%) — MEDIUM

**Uncovered:** Streaming paths for thinking blocks, tool calls, redacted thinking, cache tokens, error responses.

**Fix:** Add SSE mock streams that exercise thinking_delta, input_json_delta, redacted_thinking blocks.

### 10. wait-human.ts (76.76%) — LOW

**Uncovered:**
- Lines 42-43: Empty label → empty string
- Lines 103-124: TIMEOUT with/without default_choice
- Lines 126-131: SKIPPED answer

**Fix:** Test with TIMEOUT answer + default_choice. Test with SKIPPED answer. Test empty label.

---

## Branch Coverage Hotspots (< 80%)

| File | Branch % | Key Missing Branches |
|------|----------|---------------------|
| adapters/openai.ts | 54.38% | Streaming switch cases |
| adapters/gemini.ts | 63.54% | Streaming event types |
| adapters/anthropic.ts | 67.85% | Content type switches |
| handlers/parallel.ts | 69.56% | Join/error policies |
| handlers/fan-in.ts | 72.22% | Parse error, empty results |
| validator.ts | 76.52% | Condition syntax paths |
| loop.ts | 76.71% | Limit checks, abort, loop detection |
| pipeline.ts | 77.77% | Checkpoint, retry, goal gate |

---

## Estimated Effort to Reach 98%

~824 uncovered lines need to be covered. At roughly 10 lines of test code per uncovered line:

- **~80-100 new test cases** needed
- **~3000-4000 lines** of new test code
- **Distribution:** 5 stages, parallelizable within each stage
