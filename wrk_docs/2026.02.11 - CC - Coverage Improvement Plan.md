# Coverage Improvement Plan: 89.71% → 98%

**Date:** 2026-02-11
**Target:** 98% statement + branch coverage

## Strategy

Work in 5 stages ordered by impact. Each stage targets a specific layer/theme. Stages are sequential; within each stage, individual files can be worked in parallel.

After each stage, run `npx vitest run --coverage` to validate progress.

---

## Stage 1: Critical Gaps (55-72% files) — Target: +5% overall

**Files:** subagent.ts, interviewer.ts, parallel.ts

### 1A. subagent.ts (55% → 95%+)

Tests to add in `src/agent-loop/subagent.test.ts`:

1. **spawn() success path**: Mock Session.submit() to resolve. Verify:
   - agentSession.status becomes 'completed'
   - result.output contains last assistant turn content
   - SUBAGENT_COMPLETE event is emitted
   - parent.subagents map is updated

2. **spawn() error path**: Mock Session.submit() to reject. Verify:
   - agentSession.status becomes 'failed'
   - result.success is false
   - error message is captured in output
   - SUBAGENT_COMPLETE event fires with failure

3. **spawn() with model override**: Verify childProfile gets opts.model

4. **createSubagentTools()**: Test all 4 tool executors:
   - spawn_agent executor: calls manager.spawn(), returns JSON
   - send_input executor: calls manager.sendInput()
   - wait executor: calls manager.wait(), returns JSON
   - close_agent executor: calls manager.close()

### 1B. interviewer.ts (55% → 95%+)

Tests to add in `src/attractor/interviewer.test.ts`:

1. **ConsoleInterviewer**: Mock readline module
   - Test ask() with SINGLE_SELECT question
   - Test ask() with CONFIRM question (yes/no)
   - Test ask() with FREE_TEXT question
   - Test ask() fallback path (unknown question type)
   - Test askMultiple() processes questions sequentially
   - Test inform() outputs formatted message
   - Test close() nullifies rl interface
   - Test close() when rl is already null

2. **findMatchingOption()**: Test via ConsoleInterviewer.ask()
   - Match by key (case-insensitive)
   - Match by label (case-insensitive)
   - No match returns raw input

### 1C. parallel.ts (71% → 95%+)

Tests to add in `src/attractor/handlers/handlers.test.ts`:

1. **With executor (non-null)**:
   - Test join_policy="first_success" with at least one SUCCESS → overall SUCCESS
   - Test join_policy="first_success" with all FAIL → overall FAIL
   - Test error_policy="fail_fast" stops on first FAIL batch
   - Test max_parallel limits batch size
   - Test executor throwing exception → FAIL outcome for that branch

2. **Without executor (null)**:
   - Test simulation mode returns SUCCESS for all branches

3. **Default join policy** (neither wait_all nor first_success):
   - Test fallthrough path returns SUCCESS if any succeeded

---

## Stage 2: Engine & Validator (80-82% files) — Target: +3% overall

**Files:** pipeline.ts, validator.ts, loop.ts, session.ts

### 2A. pipeline.ts (82% → 95%+)

Tests to add in `src/attractor/engine/pipeline.test.ts`:

1. **Checkpoint resume**: Create a saved checkpoint, then run with resumeFromCheckpoint=true
2. **Checkpoint resume with no checkpoint**: Falls through to fresh start
3. **Checkpoint resume at terminal**: Returns immediately
4. **Goal gate failure + retry target**: Node with goal_gate=true that failed, retry_target set
5. **Goal gate failure without retry**: Throws error
6. **auto_status node**: Node with auto_status=true, no status.json → synthesized SUCCESS
7. **SKIPPED status**: Handler returns SKIPPED → node not in completedNodes
8. **FAIL with no outgoing edge**: Throws error
9. **loop_restart edge**: Edge with loop_restart=true triggers recursive executeLoop
10. **defaultShouldRetry**: Test with rate limit, timeout, network, auth, validation errors
11. **mirrorGraphAttributes with default_fidelity**: Graph with default_fidelity attribute

### 2B. validator.ts (80% → 98%+)

Tests to add in `src/attractor/parser/validator.test.ts`:

1. **validateConditionSyntax** via conditionSyntaxRule:
   - `a=b=c` (multiple =) → error
   - `=value` (missing key in =) → error
   - `!=value` (missing key in !=) → error
   - `a!=b!=c` (multiple !=) → error
   - Empty clause after split → skipped
2. **validate() with extraRules**: Pass custom LintRule array
3. **validateOrRaise with no errors**: Returns warnings only

### 2C. loop.ts (81% → 95%+)

Tests to add in `src/agent-loop/loop.test.ts`:

1. **processInput turn limit (max_tool_rounds_per_input)**: Mock LLM to always return tool calls → hits round limit
2. **processInput turn limit (max_turns)**: Mock enough turns to hit total turn limit
3. **processInput abort_signaled**: Set abort_signaled=true during processing
4. **processInput LLM error**: Mock LLM to throw → state=CLOSED
5. **Loop detection injection**: Create history with repeating tool call pattern
6. **Followup queue**: Queue a follow-up → gets processed after first input
7. **Parallel tool execution**: Set supports_parallel_tool_calls=true, return multiple tool calls
8. **Context usage warning**: Stuff history to exceed 80% of context_window_size
9. **Tool validation error**: Register tool with validator that rejects args

### 2D. session.ts (81% → 95%+)

Tests to add in `src/agent-loop/session.test.ts`:

1. **close() with running subagents**: Subagent status changes to 'failed'
2. **close() emits SESSION_END**: Verify event
3. **submit() on CLOSED session**: Throws
4. **submit() on PROCESSING session**: Throws
5. **Config map merging**: Pass custom tool_output_limits and tool_line_limits
6. **setReasoningEffort()**: Verify config updated
7. **abort()**: Verify abort_signaled + controller

---

## Stage 3: Handler & Parser Gaps (76-90% files) — Target: +2% overall

**Files:** wait-human.ts, fan-in.ts, dot-parser.ts, edge-selection.ts, context.ts

### 3A. wait-human.ts (77% → 98%+)

1. **TIMEOUT answer + default_choice match**: Returns SUCCESS with matched choice
2. **TIMEOUT answer + default_choice no match**: Returns RETRY
3. **TIMEOUT answer without default_choice**: Returns RETRY
4. **SKIPPED answer**: Returns FAIL
5. **Empty label**: parseAcceleratorKey returns ''

### 3B. fan-in.ts (84% → 98%+)

1. **Malformed JSON in parallel.results**: Returns FAIL with parse error message
2. **Empty results array**: Returns FAIL with "No parallel results"

### 3C. dot-parser.ts (90% → 98%+)

1. Test subgraph with class attribute
2. Test quoted attribute values with escaped quotes
3. Test edge case attribute parsing

### 3D. edge-selection.ts (95% → 98%+)

1. Test suggested_next_ids matching
2. Test weight tiebreaker (equal weights → lexical sort)

### 3E. context.ts (93% → 98%+)

1. Test get() with nested key where intermediate is null
2. Test get() with nested key where intermediate is non-object (e.g., number)

---

## Stage 4: Adapter Streaming (55-93% branches) — Target: +2% overall

**Files:** anthropic.ts, gemini.ts, openai.ts, sse.ts

### 4A. anthropic.ts streaming (89% → 98%+)

1. Stream with thinking blocks (thinking_delta events)
2. Stream with redacted_thinking blocks
3. Stream error response (4xx status)
4. Stream with cache token usage
5. Document content type translation
6. Image content types (URL and base64)

### 4B. gemini.ts streaming (89% → 98%+)

1. Stream with function call events
2. Stream with thinking parts
3. Stream error handling
4. Tool call ID mapping via name

### 4C. openai.ts streaming (93% → 98%+)

1. Stream with tool call chunks
2. Minor edge cases in chunk assembly

### 4D. sse.ts (95% → 98%+)

1. Invalid retry value
2. Stream reader error during read()

---

## Stage 5: Remaining Gaps (88-97% files) — Target: 98%+

**Files:** api.ts, client.ts, events.ts, stylesheet.ts, local.ts, gemini-profile.ts, registry.ts

### 5A. api.ts (89% → 98%+)

1. generate_object() with Anthropic provider: model doesn't call tool → fallback JSON parse → NoObjectGeneratedError
2. generate_object() with OpenAI: parse failure → NoObjectGeneratedError
3. stream() source error propagation
4. Abort signal already aborted before first round

### 5B. client.ts (94% → 98%+)

1. getDefaultClient() → from_env() path
2. setDefaultClient()
3. complete() with no provider and no default → ConfigurationError
4. complete() with unknown provider → ConfigurationError

### 5C. Remaining small gaps

- events.ts lines 118-121, 149-150
- stylesheet.ts lines 170-174, 210-211
- local.ts grep/glob functions
- gemini-profile.ts lines 163-174
- registry.ts lines 53-54

---

## Validation Checkpoints

After each stage:
```bash
npx vitest run --coverage
```

Expected cumulative progress:
| Stage | Expected Overall Lines | Expected Overall Branches |
|-------|----------------------|--------------------------|
| Start | 89.71% | 84.26% |
| 1 | ~93% | ~88% |
| 2 | ~96% | ~92% |
| 3 | ~97% | ~95% |
| 4 | ~98% | ~97% |
| 5 | ~98.5%+ | ~98%+ |

---

## Team Allocation

- **Agent A (attractor-tests)**: Stages 1C, 2A, 2B, 3A-3E — Attractor layer
- **Agent B (agent-loop-tests)**: Stages 1A, 1B, 2C, 2D — Agent loop layer
- **Agent C (unified-llm-tests)**: Stages 4A-4D, 5A-5C — Unified LLM layer

Agents work in parallel on their respective layers, with coverage verification after each stage completes.
