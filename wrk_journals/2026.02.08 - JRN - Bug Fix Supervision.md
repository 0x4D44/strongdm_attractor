# 2026.02.08 - Bug Fix Supervision Journal

## Context
Code review of the Attractor implementation (~12k LOC, 51 files) identified critical bugs,
security vulnerabilities, and spec deviations across all three components.

## Workstreams

### WS1: Security Fixes (Critical)
- [ ] Command injection in `apply_patch` delete (openai-profile.ts:233)
- [ ] Command injection in `web_fetch` (gemini-profile.ts:168)
- [ ] Shell injection in ToolHandler (tool-handler.ts:28)

### WS2: read_file Architecture Fix (Critical)
- [ ] `read_file()` returns line-numbered content, breaking `edit_file` and `apply_patch`
- Decision: Move line numbering to the tool executor layer; raw content from ExecutionEnvironment

### WS3: Unified LLM Fixes (Critical + High)
- [ ] `wrapMiddlewareForStream()` ignores middleware (middleware.ts:58-66)
- [ ] `stream()` responsePromise has no reject path (api.ts:268-272)
- [ ] `textStream()` shares iterator with `[Symbol.asyncIterator]` (api.ts:356-376)
- [ ] Anthropic `fullText` accumulates across text blocks (anthropic.ts:250,320,345)
- [ ] `abort_signal` and `timeout` unused in `generate()` (api.ts:53,77)
- [ ] Anthropic `cache_control` on all system blocks, not just last (anthropic.ts:104)
- [ ] Status 408 mapped to ServerError not RequestTimeoutError (types.ts:668)

### WS4: Attractor Engine Fixes (Critical + High)
- [ ] `buildRetryPolicy` ignores `graph.attrs.default_max_retry` (pipeline.ts:472-489)
- [ ] Edge selection regex broken for multi-char accelerators (edge-selection.ts:24)
- [ ] Checkpoint resume loses `nodeOutcomes` + uses dummy outcome (pipeline.ts:147,157)
- [ ] `loop_restart` reuses logsRoot (pipeline.ts:300-313)
- [ ] Parallel handler mutates parent context directly (parallel.ts:97)
- [ ] Missing `auto_status` implementation
- [ ] Missing `SKIPPED` status handling
- [ ] `codergen` handler missing `failure_reason` in status.json

### WS5: Agent Loop Fixes (High)
- [ ] Subagent tools never registered on profiles
- [ ] Tool argument validation skipped in main loop (loop.ts:360-363)
- [ ] SESSION_START/END emitted per-input not per-session
- [ ] `discoverProjectDocs()` called every loop iteration (loop.ts:470-473)
- [ ] Anthropic 120s shell timeout default not enforced
- [ ] Node.js 22 glob import crash on Node 20

### WS6: Additional Quality Fixes
- [ ] Context shallow clone leaks mutations in parallel
- [ ] $goal expansion happens twice (transforms + codergen handler)
- [ ] Event listener errors silently swallowed
- [ ] Subgraph class derivation is order-dependent
- [ ] Condition evaluator doesn't reject `||`

## Plan
1. Create team with 3 agents: security+architecture, unified-llm, attractor+agent-loop
2. Each agent works on their workstream(s)
3. Review fixes via /code-reviewer
4. Final build + quality check
5. Commit each fix

## Timeline
- Started: 2026-02-08
