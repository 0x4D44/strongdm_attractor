# 2026.02.08 - Bug Fix Supervision Journal

## Context
Code review of the Attractor implementation (~12k LOC, 51 files) identified critical bugs,
security vulnerabilities, and spec deviations across all three components.

## Workstreams

### WS1: Security Fixes (Critical) — DONE
- [x] Command injection in `apply_patch` delete → replaced with fs.unlinkSync/renameSync
- [x] Command injection in `web_fetch` → replaced with native fetch()
- [x] Shell injection in ToolHandler → added validation + trust model documentation

### WS2: read_file Architecture Fix (Critical) — DONE
- [x] `read_file()` returns line-numbered content → moved formatting to tool executor layer
- Decision: ExecutionEnvironment.read_file() returns raw content; readFileExecutor adds line numbers

### WS3: Unified LLM Fixes (Critical + High) — DONE
- [x] `wrapMiddlewareForStream()` ignores middleware → now applies request transformation
- [x] `stream()` responsePromise has no reject path → added reject callback
- [x] `textStream()` shares iterator → uses independent iteration with event buffering
- [x] Anthropic `fullText` accumulates across blocks → resets on content_block_start
- [x] `abort_signal` and `timeout` unused → passed through to client calls
- [x] Anthropic `cache_control` on all system blocks → only injected on last block
- [x] Status 408 mapped to ServerError → mapped to RequestTimeoutError

### WS4: Attractor Engine Fixes (Critical + High) — DONE
- [x] `buildRetryPolicy` ignores graph default → falls back to graph.attrs.default_max_retry
- [x] Edge selection regex broken → fixed to `[^\]]+`
- [x] Checkpoint resume loses state → added node_outcomes to Checkpoint, uses actual outcome
- [x] `loop_restart` reuses logsRoot → creates fresh timestamped directory
- [x] Parallel handler mutates context → returns data via context_updates
- [x] Missing `auto_status` → implemented
- [x] Missing `SKIPPED` handling → skipped nodes excluded from completedNodes
- [x] Missing `failure_reason` in status.json → added to writeStatus

### WS5: Agent Loop Fixes (High) — DONE
- [x] Subagent tools never registered → registered on all profiles
- [x] Tool argument validation skipped → added validation before execution
- [x] SESSION_START/END per-input → moved to constructor/close() only
- [x] `discoverProjectDocs()` every iteration → cached before loop
- [x] Anthropic 120s shell timeout → default enforced in Anthropic profile
- [x] Node.js 22 glob import → dynamic import with fallback

### WS6: Additional Quality Fixes — DONE
- [x] Context shallow clone → deep clone with structuredClone
- [x] $goal expansion twice → removed from codergen handler (transform handles it)
- [x] Event listener errors swallowed → logged to console.error
- [x] Subgraph class derivation order → two-pass approach
- [x] Comment escape detection → counts consecutive backslashes

## Execution

### Team Structure
- **fixer-security**: WS1 + WS2 (security + architecture) — completed first
- **fixer-llm**: WS3 (unified-llm bugs) — completed second
- **fixer-engine**: WS4 + WS5 + WS6 (attractor + agent-loop + quality) — completed third

### Quality Check
- Spawned quality-check agent to verify all 33 fixes
- Result: 10/10 critical checks passed (after 2 minor follow-up fixes)
- Build: `tsc --noEmit` = zero errors
- Smoke test: DOT parsing, validation, conditions, edge selection, context clone, stylesheet — all pass

### Commit
- Single commit: `767a848` — "feat: Implement Attractor from NLSpecs"
- 57 files changed, 13,955 insertions

## Lessons Learned
- The read_file line-numbering issue was the most architecturally impactful bug — a design
  decision in the ExecutionEnvironment broke the entire edit_file tool chain
- Security: always use Node.js fs APIs for file operations with untrusted paths, never shell
- Code review agents work well in parallel when given non-overlapping file scopes
- Quality check agent is essential — caught 2 issues the fix agents missed
